<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>FLOWORK - 온라인 관리</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .status-badge { font-size: 0.85rem; width: 80px; cursor: help; }
        .img-preview { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #dee2e6; }
        .img-placeholder { width: 40px; height: 40px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6; display: flex; align-items: center; justify-content: center; color: #adb5bd; }
        .nav-tabs .nav-link { cursor: pointer; }
        .table th { font-size: 0.85rem; vertical-align: middle; white-space: nowrap; }
        .table td { font-size: 0.9rem; vertical-align: middle; }
        .pagination { margin-bottom: 0; }
    </style>
</head>
<body data-api-list="{{ url_for('api.get_product_image_status') }}" 
      data-api-process="{{ url_for('api.trigger_image_process') }}"
      data-api-reset="{{ url_for('api.reset_image_process_status') }}"
      data-api-reset-all="{{ url_for('api.reset_all_processing_status') }}">
    
    <div class="container my-4">
        {% include '_header.html' %}
        {% include '_navigation.html' %}

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0"><i class="bi bi-globe me-2"></i>온라인 품번 관리</h2>
            <div class="d-flex gap-2">
                <span id="status-text" class="text-muted small align-self-center me-2">로딩 중...</span>
                
                <button class="btn btn-warning text-dark" id="btn-reset-status" disabled>
                    <i class="bi bi-arrow-counterclockwise me-1"></i> 선택 초기화
                </button>
                
                <button class="btn btn-primary" id="btn-start-process" disabled>
                    <i class="bi bi-play-fill me-1"></i> 처리 시작
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="managementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-processing-btn" data-bs-toggle="tab" data-bs-target="#tab-processing" type="button" data-tab-type="processing">
                            <i class="bi bi-hourglass-split me-1"></i>진행중 <span class="badge bg-primary ms-1" id="count-processing">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-failed-btn" data-bs-toggle="tab" data-bs-target="#tab-failed" type="button" data-tab-type="failed">
                            <i class="bi bi-exclamation-triangle me-1"></i>실패 <span class="badge bg-danger ms-1" id="count-failed">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-completed-btn" data-bs-toggle="tab" data-bs-target="#tab-completed" type="button" data-tab-type="completed">
                            <i class="bi bi-check-circle me-1"></i>완료목록 <span class="badge bg-success ms-1" id="count-completed">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-all-btn" data-bs-toggle="tab" data-bs-target="#tab-all" type="button" data-tab-type="all">
                            <i class="bi bi-list me-1"></i>전체목록 <span class="badge bg-secondary ms-1" id="count-all">0</span>
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body p-0">
                <div class="tab-content" id="managementTabsContent">
                    
                    <div class="tab-pane fade show active" id="tab-processing" role="tabpanel">
                        <div class="p-2 border-bottom bg-light d-flex justify-content-end">
                             <button class="btn btn-danger btn-sm" id="btn-cancel-all">
                                <i class="bi bi-stop-circle-fill me-1"></i>진행중인 작업 모두 취소
                             </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input check-all-tab" data-target="tbody-processing"></th>
                                        <th>품번</th>
                                        <th>품명</th>
                                        <th>컬러</th>
                                        <th>전체이미지</th>
                                        <th>대표이미지</th>
                                        <th>썸네일</th>
                                        <th>상세컬러</th>
                                        <th>진행상태</th>
                                        <th>전체저장</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-processing"></tbody>
                            </table>
                        </div>
                        <div class="p-2 border-top d-flex justify-content-center" id="pagination-processing"></div>
                    </div>

                    <div class="tab-pane fade" id="tab-failed" role="tabpanel">
                        <div class="table-responsive">
                             <table class="table table-hover align-middle mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input check-all-tab" data-target="tbody-failed"></th>
                                        <th>품번</th>
                                        <th>품명</th>
                                        <th>컬러</th>
                                        <th>전체이미지</th>
                                        <th>대표이미지</th>
                                        <th>썸네일</th>
                                        <th>상세컬러</th>
                                        <th>진행상태</th>
                                        <th>전체저장</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-failed"></tbody>
                            </table>
                        </div>
                        <div class="p-2 border-top d-flex justify-content-center" id="pagination-failed"></div>
                    </div>

                    <div class="tab-pane fade" id="tab-completed" role="tabpanel">
                        <div class="p-2 border-bottom bg-light">
                             <input type="text" class="form-control form-control-sm" id="search-completed" placeholder="품번 또는 상품명 검색...">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input check-all-tab" data-target="tbody-completed"></th>
                                        <th>품번</th>
                                        <th>품명</th>
                                        <th>컬러</th>
                                        <th>전체이미지</th>
                                        <th>대표이미지</th>
                                        <th>썸네일</th>
                                        <th>상세컬러</th>
                                        <th>진행상태</th>
                                        <th>전체저장</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-completed"></tbody>
                            </table>
                        </div>
                        <div class="p-2 border-top d-flex justify-content-center" id="pagination-completed"></div>
                    </div>

                    <div class="tab-pane fade" id="tab-all" role="tabpanel">
                        <div class="p-2 border-bottom bg-light">
                            <input type="text" class="form-control form-control-sm" id="search-all" placeholder="품번 또는 상품명 검색...">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input check-all-tab" data-target="tbody-all"></th>
                                        <th>품번</th>
                                        <th>품명</th>
                                        <th>컬러</th>
                                        <th>전체이미지</th>
                                        <th>대표이미지</th>
                                        <th>썸네일</th>
                                        <th>상세컬러</th>
                                        <th>진행상태</th>
                                        <th>전체저장</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-all"></tbody>
                            </table>
                        </div>
                        <div class="p-2 border-top d-flex justify-content-center" id="pagination-all"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        const btnStart = document.getElementById('btn-start-process');
        const btnReset = document.getElementById('btn-reset-status');
        const btnCancelAll = document.getElementById('btn-cancel-all');
        const statusText = document.getElementById('status-text');
        
        const API_LIST = document.body.dataset.apiList;
        const API_PROCESS = document.body.dataset.apiProcess;
        const API_RESET = document.body.dataset.apiReset;
        const API_RESET_ALL = document.body.dataset.apiResetAll;

        let isProcessing = false;
        
        // 탭별 현재 페이지 상태 관리
        const paginationState = {
            processing: 1,
            failed: 1,
            completed: 1,
            all: 1
        };

        // [초기화] 탭 클릭 이벤트
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                const tabType = e.target.dataset.tabType;
                loadData(tabType, paginationState[tabType]); // 탭 전환 시 해당 탭 데이터 로드
            });
        });

        // [초기화] 검색창 엔터/입력 이벤트
        ['search-all', 'search-completed'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                // 엔터 키 입력 시 검색 실행
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const tabType = id.replace('search-', '');
                        paginationState[tabType] = 1; // 검색 시 1페이지로 초기화
                        loadData(tabType, 1);
                    }
                });
            }
        });

        // 데이터 로드 함수 (서버 연동 핵심)
        async function loadData(tabType, page) {
            if (isProcessing) return;
            
            // 현재 탭의 검색어 가져오기
            let query = '';
            if (tabType === 'completed') {
                query = document.getElementById('search-completed').value.trim();
            } else if (tabType === 'all') {
                query = document.getElementById('search-all').value.trim();
            }

            const tbodyId = `tbody-${tabType}`;
            const paginationId = `pagination-${tabType}`;
            const tbody = document.getElementById(tbodyId);

            try {
                // 서버에 파라미터 전달 (50개씩 요청)
                const params = new URLSearchParams({
                    page: page,
                    limit: 50,          // (2) 50개씩 보기
                    tab: tabType,       // (1) 탭 구분 (backend에서 processing 필터링 처리됨)
                    query: query        // (3) 전체 데이터 대상 검색
                });

                const res = await fetch(`${API_LIST}?${params.toString()}`);
                const json = await res.json();

                if (json.status === 'success') {
                    // 테이블 렌더링
                    renderTableRows(tbodyId, json.data);
                    
                    // 페이지네이션 렌더링
                    renderPaginationControls(paginationId, tabType, json.pagination);
                    
                    // 현재 탭의 카운트 업데이트
                    const badge = document.getElementById(`count-${tabType}`);
                    if(badge) badge.textContent = json.pagination.total_items;

                    // 상태 텍스트 업데이트 (진행중인 작업 확인)
                    if (tabType === 'processing') {
                        if (json.data.length > 0) {
                            statusText.innerHTML = `<span class="spinner-border spinner-border-sm text-primary me-1"></span> 작업 목록 불러옴`;
                        } else {
                            statusText.textContent = "대기중인 작업 없음";
                        }
                    }
                }
            } catch (e) {
                console.error("Load error:", e);
                if(tbody) tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">데이터 로드 실패</td></tr>`;
            }
        }

        function renderTableRows(tbodyId, items) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="p-4 text-muted">데이터가 없습니다.</td></tr>`;
                return;
            }

            items.forEach(item => {
                const tr = document.createElement('tr');
                
                let badgeClass = 'bg-secondary';
                let statusLabel = '대기';
                // 서버에서 주는 status 값 활용
                if (item.status === 'PROCESSING') { badgeClass = 'bg-primary'; statusLabel = '진행중'; }
                else if (item.status === 'COMPLETED') { badgeClass = 'bg-success'; statusLabel = '완료'; }
                else if (item.status === 'FAILED') { badgeClass = 'bg-danger'; statusLabel = '실패'; }
                
                const titleAttr = item.message ? `title="${item.message}"` : '';
                
                // 이미지 링크 처리
                const thumbHtml = item.thumbnail 
                    ? `<a href="${item.thumbnail}" target="_blank"><img src="${item.thumbnail}" class="img-preview"></a>`
                    : `<div class="img-placeholder"><i class="bi bi-image"></i></div>`;
                
                const detailLink = item.detail 
                    ? `<a href="${item.detail}" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-file-earmark-image"></i></a>`
                    : `-`;
                
                const driveLink = item.drive_link 
                    ? `<a href="${item.drive_link}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-google"></i></a>`
                    : `-`;

                const disabled = item.status === 'PROCESSING' ? 'disabled' : '';

                tr.innerHTML = `
                    <td><input type="checkbox" class="form-check-input item-check" value="${item.style_code}" ${disabled}></td>
                    <td class="fw-bold">${item.style_code}</td>
                    <td class="text-start text-truncate" style="max-width: 150px;">${item.product_name}</td>
                    <td>${item.total_colors}</td>
                    <td>${driveLink}</td>
                    <td>-</td>
                    <td>${thumbHtml}</td>
                    <td>${detailLink}</td>
                    <td><span class="badge ${badgeClass} status-badge" ${titleAttr}>${statusLabel}</span></td>
                    <td><button class="btn btn-sm btn-outline-dark"><i class="bi bi-download"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            updateButtons();
        }

        function renderPaginationControls(containerId, tabType, pagination) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const { current_page, total_pages } = pagination;
            if (total_pages <= 1) return;

            const ul = document.createElement('ul');
            ul.className = 'pagination pagination-sm';

            // 이전 버튼
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!pagination.has_prev ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">&laquo;</a>`;
            prevLi.onclick = (e) => { 
                e.preventDefault(); 
                if(pagination.has_prev) changePage(tabType, current_page - 1); 
            };
            ul.appendChild(prevLi);

            // 페이지 번호 (현재 페이지 주변 5개만 표시)
            let startPage = Math.max(1, current_page - 2);
            let endPage = Math.min(total_pages, startPage + 4);
            if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === current_page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = (e) => { 
                    e.preventDefault(); 
                    changePage(tabType, i); 
                };
                ul.appendChild(li);
            }

            // 다음 버튼
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">&raquo;</a>`;
            nextLi.onclick = (e) => { 
                e.preventDefault(); 
                if(pagination.has_next) changePage(tabType, current_page + 1); 
            };
            ul.appendChild(nextLi);

            container.appendChild(ul);
        }

        function changePage(tabType, page) {
            paginationState[tabType] = page;
            loadData(tabType, page);
        }

        // 체크박스, 버튼 활성화 로직 등
        document.body.addEventListener('change', (e) => {
            if (e.target.classList.contains('item-check') || e.target.classList.contains('check-all-tab')) {
                updateButtons();
            }
        });
        
        // 전체 체크박스 로직
        document.querySelectorAll('.check-all-tab').forEach(checkAll => {
            checkAll.addEventListener('change', (e) => {
                const targetId = e.target.dataset.target;
                const isChecked = e.target.checked;
                const tbody = document.getElementById(targetId);
                if (tbody) {
                    tbody.querySelectorAll('.item-check:not(:disabled)').forEach(cb => {
                        cb.checked = isChecked;
                    });
                    updateButtons();
                }
            });
        });

        function updateButtons() {
            const allChecked = document.querySelectorAll('.item-check:checked');
            const count = new Set(Array.from(allChecked).map(cb => cb.value)).size;
            
            if (btnStart) btnStart.disabled = count === 0;
            if (btnReset) btnReset.disabled = count === 0;
            
            if (btnStart) {
                if (count > 0) {
                    btnStart.innerHTML = `<i class="bi bi-play-fill me-1"></i> ${count}건 처리 시작`;
                    btnReset.innerHTML = `<i class="bi bi-arrow-counterclockwise me-1"></i> 선택 초기화`;
                } else {
                    btnStart.innerHTML = `<i class="bi bi-play-fill me-1"></i> 처리 시작`;
                    btnReset.innerHTML = `<i class="bi bi-arrow-counterclockwise me-1"></i> 선택 초기화`;
                }
            }
        }
        
        // 버튼 이벤트 핸들러들
        function getSelectedCodes() {
            const allChecked = document.querySelectorAll('.item-check:checked');
            return Array.from(new Set(Array.from(allChecked).map(cb => cb.value)));
        }

        async function sendRequest(url, data) {
            isProcessing = true;
            setButtonsLoading(true);
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                alert(json.message);
            } catch (e) {
                alert('통신 오류');
            } finally {
                isProcessing = false;
                setButtonsLoading(false);
                // 현재 활성 탭 새로고침
                const activeTabBtn = document.querySelector('.nav-link.active');
                if(activeTabBtn) loadData(activeTabBtn.dataset.tabType, 1);
            }
        }
        
        function setButtonsLoading(isLoading) {
            if (btnStart) {
                if (isLoading) {
                    btnStart.disabled = true;
                    btnStart.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 처리 중...';
                } else {
                    updateButtons();
                }
            }
        }

        if(btnStart) {
            btnStart.addEventListener('click', () => {
                const codes = getSelectedCodes();
                if (codes.length === 0) return;
                if (confirm(`${codes.length}건 처리 시작?`)) sendRequest(API_PROCESS, { style_codes: codes });
            });
        }
        if(btnReset) {
            btnReset.addEventListener('click', () => {
                const codes = getSelectedCodes();
                if (codes.length === 0) return;
                if (confirm(`${codes.length}건 초기화?`)) sendRequest(API_RESET, { style_codes: codes });
            });
        }
        if(btnCancelAll) {
            btnCancelAll.addEventListener('click', () => {
                if (confirm('모든 작업 취소?')) sendRequest(API_RESET_ALL, {});
            });
        }

        // 초기 로드: 활성화된 탭 (보통 'processing')
        const initialTab = document.querySelector('.nav-link.active');
        if (initialTab) {
            loadData(initialTab.dataset.tabType, 1);
        }
    });
</script>
</body>
</html>