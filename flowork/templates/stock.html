<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>FLOWORK - 재고관리</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-analyze-excel-url="{{ url_for('product.api_analyze_excel_route') }}">
    <div class="container my-4">
        {% include '_header.html' %}
        {% include '_navigation.html' %}

        <div class="mb-4">
            <h2 class="section-title">재고 데이터</h2>

            {% if not current_user.store_id %}
            <div class="card mb-3">
                <div class="card-header"><h3>백업</h3></div>
                <div class="card-body">
                    <a href="{{ url_for('product.api_export_db') }}" class="btn btn-success">DB 다운로드</a>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-danger text-white"><h3>DB 초기화 및 전체 업로드</h3></div>
                <div class="card-body">
                    <p class="text-danger small fw-bold mb-3">
                        * 주의: 이 작업은 기존의 모든 재고 데이터를 삭제하고 엑셀 데이터로 덮어씁니다.<br>
                        * 브랜드 초기 설정이나 데이터 전체 리셋 시에만 사용하세요.
                    </p>
                    <form action="{{ url_for('product.api_inventory_upsert') }}" method="POST" enctype="multipart/form-data" id="form-import-db" class="management-form">
                        <input type="hidden" name="upload_mode" value="db">
                        <input type="hidden" name="is_full_import" value="true">
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input horizontal-mode-switch" type="checkbox" id="db_is_horizontal" name="is_horizontal">
                            <label class="form-check-label fw-bold" for="db_is_horizontal">가로형(Matrix) 엑셀 (사이즈가 가로로 나열된 경우)</label>
                        </div>

                        <div class="file-upload-wrapper mb-3" id="wrapper-db-file">
                            <label for="db_excel_file" class="form-label btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-spreadsheet me-1"></i> 엑셀 파일 선택
                            </label>
                            <input type="file" name="excel_file" id="db_excel_file" accept=".xlsx, .xls, .csv">
                            <div class="file-status-text" id="status-db-file">선택된 파일 없음</div>
                        </div>

                        <div class="column-mapping-grid" id="grid-import-db" style="display:none;">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>품번 (필수)</label>
                                    <select name="col_pn" class="form-select form-select-sm" required></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>컬러 (필수)</label>
                                    <select name="col_color" class="form-select form-select-sm" required></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper conditional-field" data-show-if="vertical">
                                <div class="mapping-item">
                                    <label>사이즈</label>
                                    <select name="col_size" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper conditional-field" data-show-if="vertical">
                                <div class="mapping-item">
                                    <label>본사 재고량</label>
                                    <select name="col_hq_stock" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>판매가</label>
                                    <select name="col_sprice" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>정상가</label>
                                    <select name="col_oprice" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>출시년도</label>
                                    <select name="col_year" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>카테고리</label>
                                    <select name="col_category" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                        </div>

                        <div class="progress-wrapper mt-3" style="display:none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div class="text-center mt-1 small progress-status">대기 중...</div>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 mt-3" style="display:none;">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> DB 초기화 및 업로드 시작
                        </button>
                    </form>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><h3>본사재고 추가 입고</h3></div>
                <div class="card-body">
                    <form action="{{ url_for('product.api_inventory_upsert') }}" method="POST" enctype="multipart/form-data" id="form-update-hq-full">
                        <input type="hidden" name="upload_mode" value="hq">
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input horizontal-mode-switch" type="checkbox" id="hq_is_horizontal" name="is_horizontal">
                            <label class="form-check-label" for="hq_is_horizontal">가로형(Matrix) 엑셀</label>
                        </div>

                        <div class="file-upload-wrapper mb-3" id="wrapper-hq-file-full">
                            <label for="hq_stock_excel_file_full" class="form-label btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-spreadsheet me-1"></i> 엑셀 파일 선택
                            </label>
                            <input type="file" name="excel_file" id="hq_stock_excel_file_full" accept=".xlsx, .xls, .csv">
                            <div class="file-status-text" id="status-hq-file-full">선택된 파일 없음</div>
                        </div>

                        <div class="column-mapping-grid" id="grid-update-hq-full" style="display:none;">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>품번 (필수)</label>
                                    <select name="col_pn" class="form-select form-select-sm" required></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>컬러 (필수)</label>
                                    <select name="col_color" class="form-select form-select-sm" required></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper conditional-field" data-show-if="vertical">
                                <div class="mapping-item">
                                    <label>사이즈</label>
                                    <select name="col_size" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper conditional-field" data-show-if="vertical">
                                <div class="mapping-item">
                                    <label>입고 수량</label>
                                    <select name="col_hq_stock" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                        </div>

                        <div class="progress-wrapper mt-3" style="display:none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div class="text-center mt-1 small progress-status">대기 중...</div>
                        </div>

                        <button class="btn btn-primary w-100 mt-3" type="submit" style="display:none;">
                            <i class="bi bi-arrow-clockwise me-1"></i> 검토 및 업로드
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

            <div class="card mb-3">
                <div class="card-header"><h3>매장재고 업데이트</h3></div>
                <div class="card-body">
                    <form action="{{ url_for('product.api_update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" id="form-update-store">
                        {% if not current_user.store_id %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">대상 매장</label>
                            <select name="target_store_id" class="form-select" required>
                                <option value="">-- 매장 선택 --</option>
                                {% for s in all_stores %}<option value="{{ s.id }}">{{ s.store_name }}</option>{% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input horizontal-mode-switch" type="checkbox" id="store_is_horizontal" name="is_horizontal">
                            <label class="form-check-label" for="store_is_horizontal">가로형(Matrix) 엑셀</label>
                        </div>

                        <div class="file-upload-wrapper mb-3" id="wrapper-store-file">
                            <label for="store_stock_excel_file" class="form-label btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-spreadsheet me-1"></i> 엑셀 파일 선택
                            </label>
                            <input type="file" name="excel_file" id="store_stock_excel_file" accept=".xlsx, .xls, .csv">
                            <div class="file-status-text" id="status-store-file">선택된 파일 없음</div>
                        </div>

                        <div class="column-mapping-grid" id="grid-update-store" style="display:none;">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>품번 (필수)</label>
                                    <select name="col_pn" class="form-select form-select-sm" required></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label>컬러 (필수)</label>
                                    <select name="col_color" class="form-select form-select-sm" required></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper conditional-field" data-show-if="vertical">
                                <div class="mapping-item">
                                    <label>사이즈</label>
                                    <select name="col_size" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper conditional-field" data-show-if="vertical">
                                <div class="mapping-item">
                                    <label>재고 수량</label>
                                    <select name="col_store_stock" class="form-select form-select-sm"></select>
                                    <div class="col-preview"></div>
                                </div>
                            </div>
                        </div>

                        <div class="progress-wrapper mt-3" style="display:none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div class="text-center mt-1 small progress-status">대기 중...</div>
                        </div>

                        <button class="btn btn-primary w-100 mt-3" type="submit" style="display:none;">
                            <i class="bi bi-arrow-clockwise me-1"></i> 검토 및 업로드
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="verification-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark"><i class="bi bi-exclamation-triangle-fill me-2"></i>데이터 검증 알림</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold">다음 행들에서 문제가 발견되었습니다.</p>
                    <p class="small text-muted">해당 행을 제외하고 업로드하려면 [제외하기] 버튼을 누른 후 확인을 클릭하세요.</p>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">Excel 행</th>
                                    <th>내용 (미리보기)</th>
                                    <th>원인</th>
                                    <th style="width: 80px;">제외</th>
                                </tr>
                            </thead>
                            <tbody id="suspicious-rows-tbody"></tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-end">
                        <span class="me-2">총 <strong id="suspicious-count" class="text-danger">0</strong>건의 문제</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-verification" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-upload">확인 후 진행</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/stock.js') }}"></script>
</body>
</html>