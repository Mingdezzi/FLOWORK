<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOWORK</title>
    
    <link rel="icon" href="{{ url_for('static', filename='symbol.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/journal/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .container { 
            /* (*** ìˆ˜ì •: width ê³ ì • ***) */
            width: 800px; 
            max-width: 100%; 
        }
        .navbar-brand { font-weight: bold; }
        .card-header h3 { font-size: 1.15rem; font-weight: 500;}
        .management-form button { flex-shrink: 0; }
        .reset-button { background-color: #ffc107; color: #333; border: none;}
        .reset-button:hover { background-color: #e0a800; color:#333; }
        html { overflow-y: scroll; }

        #scan-table th, #scan-table td {
            font-size: 0.85rem; padding: 0.5rem 0.25rem; vertical-align: middle; text-align: center;
        }
        #scan-table td:nth-child(1), #scan-table th:nth-child(1) { text-align: left; padding-left: 0.5rem; font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #scan-table td:nth-child(2), #scan-table th:nth-child(2) { max-width: 70px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .scan-quantity-input { width: 45px; text-align: center; padding: 0.25rem 0.1rem; height: auto; }
        .scan-diff { font-weight: bold; }
        .scan-diff.positive { color: #007bff; }
        .scan-diff.negative { color: #eb6864; }
        #scan-status-alert { display: none; }
        .section-title { font-size: 1.3rem; font-weight: 500; color: #212529; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }

        #toggle-scan-btn { width: 120px; }

        .btn-db-reset-all { background-color: #dc3545; border-color: #dc3545; color: white; }
        .btn-db-reset-all:hover { background-color: #c82333; border-color: #bd2130; color: white; }

        .nav-tabs .nav-link.active, .nav-tabs .nav-item.show .nav-link {
            color: #eb6864; background-color: transparent; border-color: #dee2e6 #dee2e6 #fff; border-bottom: 2px solid #eb6864;
        }
        .nav-tabs { border-bottom: 1px solid #dee2e6; }
        .nav-link { color: #6c757d; }

        /* (*** ìˆ˜ì •: ì—´ ë§¤í•‘ ê·¸ë¦¬ë“œ -> 2ë‹¨ìœ¼ë¡œ ë³€ê²½ ***) */
        .column-mapping-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 2ë‹¨ ê·¸ë¦¬ë“œ */
            gap: 0.75rem; 
            align-items: start; /* ìƒë‹¨ ì •ë ¬ */
        }
        .mapping-item {
            display: flex;
            flex-direction: column;
        }
        .mapping-item label { 
            font-size: 0.85rem; 
            margin-bottom: 0.2rem; 
            display: block; 
            font-weight: 500;
        }
        .mapping-item select { 
            font-size: 0.9rem; 
            padding: 0.25rem 0.5rem; 
            height: auto; /* (*** ìˆ˜ì •: ë†’ì´ ìë™ ***) */
        }
        .update-stock-form button { 
            margin-top: 1rem; 
        }
        
        /* (*** ì¶”ê°€: ì—´ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ***) */
        .col-preview {
            font-size: 0.75rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.3rem 0.5rem;
            margin-top: 0.25rem;
            min-height: 80px; /* ìµœì†Œ ë†’ì´ */
        }
        .col-preview ul {
            margin: 0;
            padding-left: 1.1rem;
        }
        .col-preview li {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .col-preview li:first-child {
            font-weight: bold; /* í—¤ë” */
            color: #343a40;
        }

        /* (*** ì¶”ê°€: 5ê°œ í•­ëª©ì„ 2x3 ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜ ***) */
        .column-mapping-grid .mapping-item-wrapper:nth-child(1) { grid-column: 1 / 2; grid-row: 1 / 2; }
        .column-mapping-grid .mapping-item-wrapper:nth-child(2) { grid-column: 2 / 3; grid-row: 1 / 2; }
        .column-mapping-grid .mapping-item-wrapper:nth-child(3) { grid-column: 1 / 2; grid-row: 2 / 3; }
        .column-mapping-grid .mapping-item-wrapper:nth-child(4) { grid-column: 2 / 3; grid-row: 2 / 3; }
        .column-mapping-grid .mapping-item-wrapper:nth-child(5) { grid-column: 1 / 2; grid-row: 3 / 4; }

        /* (*** ì¶”ê°€: íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ ***) */
        .file-upload-wrapper {
             border: 2px dashed #dee2e6;
             border-radius: 0.375rem;
             padding: 1rem;
             text-align: center;
             background-color: #f8f9fa;
             transition: background-color 0.2s, border-color 0.2s;
        }
        .file-upload-wrapper.loading {
             background-color: #e9ecef;
             border-color: #adb5bd;
        }
        .file-upload-wrapper.success {
             background-color: #e6f9f0;
             border-color: #28a745;
        }
        .file-upload-wrapper.error {
             background-color: #fdf0f1;
             border-color: #dc3545;
        }
        .file-upload-wrapper .form-label {
             margin-bottom: 0;
             font-weight: 500;
             color: #495057;
        }
        .file-upload-wrapper input[type="file"] {
             display: none; /* ìˆ¨ê¹€ */
        }
         .file-upload-wrapper .file-status-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
            min-height: 1.2em; /* ë†’ì´ ê³ ì • */
        }
        
        .column-mapping-grid {
            display: none; /* (*** ì¶”ê°€: ì²˜ìŒì—” ìˆ¨ê¹€ ***) */
        }
        .update-stock-form button[type="submit"] {
            display: none; /* (*** ì¶”ê°€: ì²˜ìŒì—” ìˆ¨ê¹€ ***) */
        }


        .missing-data-table th, .missing-data-table td { font-size: 0.9rem; vertical-align: middle; }

        /* (*** ì¶”ê°€: ìš”ì²­í•˜ì‹  ì„¤ëª…ë€ ìŠ¤íƒ€ì¼ ***) */
        .card-description {
            font-size: 0.9rem; /* Uniform font size */
            color: #6c757d; /* Standard text color (text-muted) */
            margin-bottom: 1rem; /* Standard margin */
            line-height: 1.5;
        }
        .card-description strong {
            font-weight: 600; /* Bold text */
            color: #212529; /* Darker text */
            display: block; /* Make it its own line */
            margin-bottom: 0.1rem;
        }
        .card-description span {
            font-weight: 400; /* Normal text */
            display: block;
        }
        /* (*** ì¶”ê°€: ìœ„í—˜ í•­ëª©(DB ì „ì²´ ì´ˆê¸°í™”) ì„¤ëª…ë€ ìŠ¤íƒ€ì¼ ***) */
        .card-description.text-danger strong,
        .card-description.text-danger span {
            color: #dc3545; /* Danger text color */
        }

    </style>
</head>
<body>
    <div class="container my-4">
        
        <header class="text-center mb-4">
            <a href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="FLOWORK Logo" style="height: 40px; object-fit: contain;">
            </a>
        </header>

        <ul class="nav nav-tabs nav-fill mb-3">
            <li class="nav-item">
                <a href="{{ url_for('index') }}" class="nav-link {{ 'active' if active_page == 'index' else '' }}">
                   <i class="bi bi-search me-1"></i> ê²€ìƒ‰
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('list_page') }}" class="nav-link {{ 'active' if active_page == 'list' else '' }}">
                   <i class="bi bi-list-columns-reverse me-1"></i> ìƒì„¸ ê²€ìƒ‰
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('stock_management') }}" class="nav-link {{ 'active' if active_page == 'stock' else '' }}">
                   <i class="bi bi-database me-1"></i> DB ê´€ë¦¬
                </a>
            </li>
        </ul>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert {{ 'alert-success' if category == 'success' else ('alert-info' if category == 'info' else ('alert-warning' if category == 'warning' else 'alert-danger')) }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="mb-4">
            <h2 class="section-title"><i class="bi bi-clipboard-check me-2"></i>ì¬ê³  ì‹¤ì‚¬</h2>

            <div class="card mb-3 management-section">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0"><i class="bi bi-upc-scan me-2"></i>ë°”ì½”ë“œ ë¦¬ë”©</h3>
                    <button class="btn btn-success btn-sm" id="toggle-scan-btn">
                        <i class="bi bi-power me-1"></i> ë¦¬ë”© ON
                    </button>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ì¬ê³  ì‹¤ì‚¬ë¥¼ ë°”ì½”ë“œ ë¦¬ë”©ì„ í†µí•´ ì‰½ê²Œ ì§„í–‰í•©ë‹ˆë‹¤.</strong>
                        <span>ìš°ì¸¡ ìƒë‹¨ì˜ 'ë¦¬ë”© ON' ë²„íŠ¼ì„ ëˆ„ë¥´ê³ , ë°”ì½”ë“œë¥¼ ë¦¬ë”©í•˜ì„¸ìš”.<br>í•˜ë‹¨ì˜ 'ìµœì¢… ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì €ì¥ ë©ë‹ˆë‹¤.</span>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="barcode-input" placeholder="ë¦¬ë”© OFF ìƒíƒœ..." autocomplete="off" disabled>
                    </div>
                    <div class="alert alert-danger alert-dismissible fade show" id="scan-status-alert" role="alert">
                        <span id="scan-status-message"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div class="table-responsive mb-2" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="scan-table">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>í’ˆë²ˆ/í’ˆëª…</th>
                                    <th>ì»¬ëŸ¬</th>
                                    <th>ì‚¬ì´ì¦ˆ</th>
                                    <th>ë§¤ì¥ì¬ê³ </th>
                                    <th>ì‹¤ì‚¬ì¬ê³ (ìŠ¤ìº”)</th>
                                    <th>ê³¼ë¶€ì¡±</th>
                                </tr>
                            </thead>
                            <tbody id="scan-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span id="scan-total-status" class="text-muted small">ì´ <strong>0</strong> ê°œ í’ˆëª© (<strong>0</strong>ê°œ)</span>
                        <div>
                            <button class="btn btn-warning" id="clear-scan-btn"><i class="bi bi-arrow-counterclockwise me-1"></i>ëª©ë¡ ì´ˆê¸°í™”</button>
                            <button class="btn btn-primary" id="submit-scan-btn"><i class="bi bi-send-check me-1"></i>ìµœì¢… ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 management-section">
                 <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-file-earmark-excel-fill me-2"></i>ì¬ê³  ì‹¤ì‚¬ ì—‘ì…€ ì¶œë ¥</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ì¬ê³  ì‹¤ì‚¬ ê²°ê³¼ë¥¼ ì—‘ì…€ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ 'ì—‘ì…€ ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¬ê³  ì‹¤ì‚¬ ê²°ê³¼ê°€ ì—‘ì…€ë¡œ ì¶œë ¥ ë©ë‹ˆë‹¤.</span>
                    </div>
                    <a href="{{ url_for('export_stock_check') }}" class="btn btn-success export-button"><i class="bi bi-download me-1"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
            </div>

            <div class="card mb-3 management-section">
                 <div class="card-header">
                     <h3 class="mb-0"><i class="bi bi-eraser-fill me-2"></i>ì¬ê³  ì‹¤ì‚¬ ì „ì²´ ì´ˆê¸°í™”</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ì¬ê³  ì‹¤ì‚¬ ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ 'ì¬ê³  ì‹¤ì‚¬ ì „ì²´ ì´ˆê¸°í™”' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ì¬ê³  ì‹¤ì‚¬ ë‚´ì—­ì´ ì‚­ì œ ë©ë‹ˆë‹¤.</span>
                    </div>
                    <form action="{{ url_for('reset_actual_stock') }}" method="POST" onsubmit="return confirm('ê²½ê³ ! ëª¨ë“  ìƒí’ˆì˜ ì‹¤ì‚¬ì¬ê³  ê¸°ë¡ì„ ì´ˆê¸°í™”(ì‚­ì œ)í•©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn reset-button"><i class="bi bi-trash3-fill me-1"></i>ì´ˆê¸°í™”</button>
                    </form>
                </div>
            </div>
        </div>

        <hr class="my-4"> <div class="mb-4">
             <h2 class="section-title"><i class="bi bi-database-gear me-2"></i>DB ê´€ë¦¬</h2>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-database-fill-up me-2"></i>DB ë°±ì—…</h3>
                </div>
                <div class="card-body">
                     <div class="card-description">
                        <strong>ì„œë²„ì˜ DB ë¥¼ ì—‘ì…€ë¡œ ë°±ì—…í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ 'ì—‘ì…€ ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ DB ë¥¼ ì—‘ì…€ë¡œ ì¶œë ¥ ë©ë‹ˆë‹¤.</span>
                    </div>
                    <a href="{{ url_for('export_db_excel') }}" class="btn btn-success"><i class="bi bi-download me-1"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
            </div>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-database-fill-down me-2"></i>DB ì—…ë¡œë“œ</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ì„œë²„ì˜ DB ë¥¼ ì—…ë¡œë“œ í•˜ê³  ì¬ì„¤ì • í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ 'íŒŒì¼ ì„ íƒ' ì„ ëˆŒëŸ¬ì„œ ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¨ ë’¤, <br> ìš°ì¸¡ í•˜ë‹¨ì˜ 'ì—…ë¡œë“œ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê¸°ì¡´ DB ê°€ ëª¨ë‘ ì‚­ì œ ë˜ê³  ì—…ë¡œë“œ í•œ DB ë¡œ ì¬ì„¤ì • ë©ë‹ˆë‹¤.</span>
                    </div>
                    <form action="{{ url_for('import_excel') }}" method="POST" enctype="multipart/form-data" class="management-form input-group" onsubmit="return confirm('ğŸš¨ ê²½ê³ ! DBë¥¼ ë®ì–´ì”ë‹ˆë‹¤.\nê¸°ì¡´ ìƒí’ˆ, ì¬ê³ , ì‹¤ì‚¬ì¬ê³  ë°ì´í„°ê°€ ëª¨ë‘ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="excelFile">
                        <button type="submit" class="btn btn-danger"><i class="bi bi-upload me-1"></i>ì—…ë¡œë“œ</button>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>ëˆ„ë½ DB ìë™ ë™ê¸°í™”</h3>
                </div>
                <div class="card-body">
                     <div class="card-description">
                        <strong>DB ì˜ ëˆ„ë½ëœ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ë™ê¸°í™” í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ 'ë°ì´í„° ë™ê¸°í™” ì‹¤í–‰' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, <br>[ë§¤ì¥ì¬ê³  ì—…ë°ì´íŠ¸] ë° [ë³¸ì‚¬ì¬ê³  ì—…ë°ì´íŠ¸] ë¥¼ ì‹¤í–‰ í›„, <br>DB ì˜ ëˆ„ë½ ëœ ë¶€ë¶„ì„ ìë™ìœ¼ë¡œ ë™ê¸°í™” í•©ë‹ˆë‹¤.</span>
                    </div>
                    <form action="{{ url_for('sync_missing_data') }}" method="POST" onsubmit="return confirm('ë°ì´í„° ë™ê¸°í™”ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.\në¹„ì–´ìˆëŠ” í’ˆëª©/ë…„ë„/ê°€ê²© ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn btn-info"><i class="bi bi-check2-circle me-1"></i>ë°ì´í„° ë™ê¸°í™” ì‹¤í–‰</button>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-house-gear me-2"></i>ë§¤ì¥ì¬ê³  ì—…ë°ì´íŠ¸</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ë§¤ì¥ì¬ê³ ë¥¼ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.</strong>
                        <span>(1) 'íŒŒì¼ ì„ íƒ'ì„ ëˆŒëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ë©´ (2) ì—´ ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.<br>(3) ê° í•­ëª©ì— ë§ëŠ” ì—‘ì…€ ì—´(A, B, C...)ì„ ì„ íƒí•˜ê³  (4) ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•œ ë’¤ (5) 'ë§¤ì¥ì¬ê³  ì—…ë°ì´íŠ¸' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</span>
                    </div>
                    
                    <form action="{{ url_for('update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" 
                          class="update-stock-form" id="form-update-store"
                          onsubmit="return confirm('ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤ì¥ ì¬ê³ ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.\nDBì— ì—†ëŠ” ìƒí’ˆì€ ì¶”ê°€ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        
                        <div class="mb-3">
                            <label for="store_stock_excel_file" class="form-label file-upload-wrapper" id="wrapper-store-file">
                                <i class="bi bi-file-earmark-excel-fill fs-4"></i>
                                <div>íŒŒì¼ ì„ íƒ (ë§¤ì¥ì¬ê³ )</div>
                                <div class="file-status-text" id="status-store-file">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
                            </label>
                            <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="store_stock_excel_file">
                        </div>
                        
                        <div class="column-mapping-grid mb-3" id="grid-update-store">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_pn_store">í’ˆë²ˆ*</label>
                                    <select id="col_pn_store" name="col_product_number" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_pn_store"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_pname_store">í’ˆëª…*</label>
                                    <select id="col_pname_store" name="col_product_name" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_pname_store"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_color_store">ì»¬ëŸ¬*</label>
                                    <select id="col_color_store" name="col_color" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_color_store"></div>
                                </div>
                            </div>
                             <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_size_store">ì‚¬ì´ì¦ˆ*</label>
                                    <select id="col_size_store" name="col_size" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_size_store"></div>
                                </div>
                            </div>
                             <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_stock_store">ë§¤ì¥ì¬ê³ *</label>
                                    <select id="col_stock_store" name="col_stock" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_stock_store"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>ë§¤ì¥ì¬ê³  ì—…ë°ì´íŠ¸</button>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-building-gear me-2"></i>ë³¸ì‚¬ì¬ê³  ì—…ë°ì´íŠ¸</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ë³¸ì‚¬ì¬ê³ ë¥¼ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.</strong>
                        <span>(1) 'íŒŒì¼ ì„ íƒ'ì„ ëˆŒëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ë©´ (2) ì—´ ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.<br>(3) ê° í•­ëª©ì— ë§ëŠ” ì—‘ì…€ ì—´(A, B, C...)ì„ ì„ íƒí•˜ê³  (4) ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•œ ë’¤ (5) 'ë³¸ì‚¬ì¬ê³  ì—…ë°ì´íŠ¸' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</span>
                    </div>
                    
                    <form action="{{ url_for('update_hq_stock_excel') }}" method="POST" enctype="multipart/form-data" 
                          class="update-stock-form" id="form-update-hq"
                          onsubmit="return confirm('ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ ë³¸ì‚¬ ì¬ê³ ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.\nDBì— ì—†ëŠ” ìƒí’ˆì€ ì¶”ê°€ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        
                        <div class="mb-3">
                             <label for="hq_stock_excel_file" class="form-label file-upload-wrapper" id="wrapper-hq-file">
                                <i class="bi bi-file-earmark-excel-fill fs-4"></i>
                                <div>íŒŒì¼ ì„ íƒ (ë³¸ì‚¬ì¬ê³ )</div>
                                <div class="file-status-text" id="status-hq-file">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
                            </label>
                            <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="hq_stock_excel_file">
                        </div>

                        <div class="column-mapping-grid mb-3" id="grid-update-hq">
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_pn_hq">í’ˆë²ˆ*</label>
                                    <select id="col_pn_hq" name="col_product_number" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_pn_hq"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_pname_hq">í’ˆëª…*</label>
                                    <select id="col_pname_hq" name="col_product_name" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_pname_hq"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_color_hq">ì»¬ëŸ¬*</label>
                                    <select id="col_color_hq" name="col_color" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_color_hq"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_size_hq">ì‚¬ì´ì¦ˆ*</label>
                                    <select id="col_size_hq" name="col_size" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_size_hq"></div>
                                </div>
                            </div>
                            <div class="mapping-item-wrapper">
                                <div class="mapping-item">
                                    <label for="col_stock_hq">ë³¸ì‚¬ì¬ê³ *</label>
                                    <select id="col_stock_hq" name="col_stock" class="form-select form-select-sm" required disabled>
                                        <option value="">-- ì—´ ì„ íƒ --</option>
                                    </select>
                                    <div class="col-preview" id="preview_col_stock_hq"></div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>ë³¸ì‚¬ì¬ê³  ì—…ë°ì´íŠ¸</button>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section border-danger">
                 <div class="card-header bg-danger text-white">
                     <h3 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>ì„œë²„ ì¤‘ë‹¨ ë° DB ì´ˆê¸°í™”</h3>
                </div>
                <div class="card-body">
                    <div class="card-description text-danger">
                        <strong>ì„œë²„ë¥¼ SHUTDOWN í•˜ê³ , DB ë¥¼ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ 'ì„œë²„ ì¤‘ë‹¨ ë° DB ì´ˆê¸°í™”' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì§„í–‰ë©ë‹ˆë‹¤. <br>ì´ ê³¼ì •ì€ ì ˆëŒ€ ëŒì´í‚¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. DB ë°±ì—…ì„ ë¨¼ì € ê¶Œê³  ë“œë¦½ë‹ˆë‹¤.</span>
                    </div>
                    <form action="{{ url_for('reset_database_completely') }}" method="POST" onsubmit="return confirm('ğŸš¨ğŸš¨ğŸš¨ ìµœì¢… ê²½ê³ ! ğŸš¨ğŸš¨ğŸš¨\n\në°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ìƒí’ˆ, ì¬ê³  ì •ë³´ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn btn-db-reset-all"><i class="bi bi-trash3-fill me-1"></i>ì„œë²„ ì¤‘ë‹¨ ë° DB ì´ˆê¸°í™”</button>
                    </form>
                </div>
            </div>

            <div class="card mb-3 management-section">
                 <div class="card-header">
                     <h3 class="mb-0"><i class="bi bi-pencil-square me-2"></i>ëˆ„ë½ DB ìˆ˜ë™ ì—…ë¡œë“œ</h3>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        <strong>ëˆ„ë½ëœ DB ì˜ í•­ëª©ì„ ìˆ˜ë™ìœ¼ë¡œ ê¸°ë¡í•˜ì—¬ ì—…ë¡œë“œ í•©ë‹ˆë‹¤.</strong>
                        <span>í•˜ë‹¨ì˜ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” í•­ëª©ì„ í´ë¦­ í•˜ì—¬, ëˆ„ë½ ëœ ë°ì´í„°ë¥¼ ì…ë ¥ í›„ ì €ì¥ í•©ë‹ˆë‹¤.</span>
                    </div>
                    {% if missing_data_products %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover missing-data-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>í’ˆë²ˆ</th>
                                        <th>í’ˆëª… (ì„ì‹œ)</th>
                                        <th>ëˆ„ë½ ì •ë³´</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for product in missing_data_products %}
                                    <tr>
                                        <td>{{ product.product_number }}</td>
                                        <td>{{ product.product_name }}</td>
                                        <td>
                                            {% if not product.release_year %}ë…„ë„ {% endif %}
                                            {% if not product.item_category %}í’ˆëª©{% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('product_detail', product_number=product.product_number) }}" class="btn btn-sm btn-outline-primary">
                                                ìˆ˜ì •í•˜ê¸° <i class="bi bi-pencil-fill ms-1"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">ë°ì´í„° ìˆ˜ì •ì´ í•„ìš”í•œ ì‹ ê·œ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha354-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ë°”ì½”ë“œ ë¦¬ë”© ì„¹ì…˜ (ê¸°ì¡´ê³¼ ë™ì¼) ---
            const barcodeInput = document.getElementById('barcode-input');
            const tableBody = document.getElementById('scan-table-body');
            const statusAlert = document.getElementById('scan-status-alert');
            const statusMessage = document.getElementById('scan-status-message');
            const totalStatus = document.getElementById('scan-total-status');
            const clearBtn = document.getElementById('clear-scan-btn');
            const submitBtn = document.getElementById('submit-scan-btn');
            const toggleScanBtn = document.getElementById('toggle-scan-btn');

            let isScanningEnabled = false;

            const korToEngMap = { 'ã…‚': 'q', 'ã…ˆ': 'w', 'ã„·': 'e', 'ã„±': 'r', 'ã……': 't', 'ã…›': 'y', 'ã…•': 'u', 'ã…‘': 'i', 'ã…': 'o', 'ã…”': 'p', 'ã…': 'a', 'ã„´': 's', 'ã…‡': 'd', 'ã„¹': 'f', 'ã…': 'g', 'ã…—': 'h', 'ã…“': 'j', 'ã…': 'k', 'ã…£': 'l', 'ã…‹': 'z', 'ã…Œ': 'x', 'ã…Š': 'c', 'ã…': 'v', 'ã… ': 'b', 'ã…œ': 'n', 'ã…¡': 'm', 'ã…ƒ': 'Q', 'ã…‰': 'W', 'ã„¸': 'E', 'ã„²': 'R', 'ã…†': 'T', 'ã…’': 'O', 'ã…–': 'P' };

            if(barcodeInput) {
                barcodeInput.addEventListener('input', (e) => {
                    const originalValue = e.target.value;
                    const selectionStart = e.target.selectionStart;
                    const regex = /[^A-Za-z0-9-]/g;
                    const convertedValue = originalValue.replace(regex, (match) => { return korToEngMap[match] || ''; });
                    if (originalValue !== convertedValue) {
                        e.target.value = convertedValue;
                        e.target.setSelectionRange(selectionStart, selectionStart);
                    }
                });
            }

            const showScanError = (message) => {
                statusMessage.textContent = message;
                statusAlert.classList.remove('alert-success');
                statusAlert.classList.add('alert-danger');
                statusAlert.style.display = 'block';
            };

            if(toggleScanBtn) {
                toggleScanBtn.addEventListener('click', () => {
                    isScanningEnabled = !isScanningEnabled;
                    barcodeInput.disabled = !isScanningEnabled;
                    if (isScanningEnabled) {
                        toggleScanBtn.innerHTML = '<i class="bi bi-power me-1"></i> ë¦¬ë”© OFF';
                        toggleScanBtn.classList.remove('btn-success');
                        toggleScanBtn.classList.add('btn-danger');
                        barcodeInput.placeholder = 'ë°”ì½”ë“œ ìŠ¤ìº” ëŒ€ê¸° ì¤‘...';
                        barcodeInput.focus();
                    } else {
                        toggleScanBtn.innerHTML = '<i class="bi bi-power me-1"></i> ë¦¬ë”© ON';
                        toggleScanBtn.classList.remove('btn-danger');
                        toggleScanBtn.classList.add('btn-success');
                        barcodeInput.placeholder = 'ë¦¬ë”© OFF ìƒíƒœ...';
                    }
                });
            }

            if(barcodeInput) {
                barcodeInput.addEventListener('keydown', (e) => {
                    if (!isScanningEnabled) return;
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        e.preventDefault();
                        const barcode = barcodeInput.value.trim();
                        if (barcode) {
                            barcodeInput.disabled = true;
                            toggleScanBtn.disabled = true;
                            fetchAndAddItem(barcode);
                            barcodeInput.value = '';
                        }
                    }
                });
            }

            const fetchAndAddItem = (barcode) => {
                fetch("{{ url_for('api_fetch_variant') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ barcode: barcode })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        statusAlert.style.display = 'none';
                        addItemToTable(data);
                    } else {
                        showScanError(data.message);
                    }
                })
                .catch(error => {
                    console.error('API Fetch ì˜¤ë¥˜:', error);
                    showScanError('ì„œë²„ í†µì‹  ì˜¤ë¥˜.');
                })
                .finally(() => {
                    if (isScanningEnabled) {
                        barcodeInput.disabled = false;
                        barcodeInput.focus();
                    }
                    toggleScanBtn.disabled = false;
                });
            };

            const addItemToTable = (item) => {
                const cleanedDbBarcode = item.barcode.replace(/-/g, '').toUpperCase();
                const existingRow = document.getElementById(`row-${cleanedDbBarcode}`);
                if (existingRow) {
                    const quantityInput = existingRow.querySelector('.scan-quantity-input');
                    quantityInput.value = parseInt(quantityInput.value) + 1;
                    quantityInput.dispatchEvent(new Event('input'));
                    existingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    existingRow.classList.add('table-info');
                    setTimeout(() => existingRow.classList.remove('table-info'), 500);
                } else {
                    const newRow = tableBody.insertRow(0);
                    newRow.id = `row-${cleanedDbBarcode}`;
                    newRow.dataset.barcode = item.barcode;
                    newRow.dataset.storeStock = item.store_stock;
                    newRow.innerHTML = `
                        <td><div class="fw-bold">${item.product_number}</div><div class="small text-muted">${item.product_name}</div></td>
                        <td>${item.color || ''}</td>
                        <td>${item.size || ''}</td>
                        <td class="store-stock">${item.store_stock}</td>
                        <td>
                            <div class="input-group input-group-sm justify-content-center">
                                <button class="btn btn-outline-danger btn-sm btn-dec" type="button">-</button>
                                <input type="number" class="form-control scan-quantity-input" value="1" min="0">
                                <button class="btn btn-outline-primary btn-sm btn-inc" type="button">+</button>
                            </div>
                        </td>
                        <td class="scan-diff"></td>`;
                    updateRowShortfall(newRow);
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                updateTotalStatus();
            };

            const updateRowShortfall = (row) => {
                const storeStock = parseInt(row.dataset.storeStock, 10);
                const actualStock = parseInt(row.querySelector('.scan-quantity-input').value, 10) || 0;
                const diff = storeStock - actualStock;
                const diffCell = row.querySelector('.scan-diff');
                diffCell.textContent = diff;
                diffCell.className = 'scan-diff';
                if (diff > 0) diffCell.classList.add('positive');
                else if (diff < 0) diffCell.classList.add('negative');
            };

            const updateTotalStatus = () => {
                const rows = tableBody.querySelectorAll('tr');
                let totalItems = 0;
                rows.forEach(row => { totalItems += parseInt(row.querySelector('.scan-quantity-input').value, 10) || 0; });
                totalStatus.innerHTML = `ì´ <strong>${rows.length}</strong> ê°œ í’ˆëª© (<strong>${totalItems}</strong>ê°œ)`;
            };

            if(tableBody) {
                tableBody.addEventListener('input', (e) => {
                    if (e.target.classList.contains('scan-quantity-input')) {
                        const row = e.target.closest('tr');
                        if (parseInt(e.target.value) < 0 || e.target.value === '') { e.target.value = 0; }
                        updateRowShortfall(row);
                        updateTotalStatus();
                    }
                });

                tableBody.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const row = button.closest('tr');
                    const quantityInput = row.querySelector('.scan-quantity-input');
                    let quantity = parseInt(quantityInput.value, 10) || 0;
                    if (button.classList.contains('btn-inc')) { quantityInput.value = quantity + 1; }
                    else if (button.classList.contains('btn-dec')) { quantityInput.value = Math.max(0, quantity - 1); }
                    quantityInput.dispatchEvent(new Event('input'));
                });
            }

            if(submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const rows = tableBody.querySelectorAll('tr');
                    if (rows.length === 0) { alert('ì €ì¥í•  ìƒì„¸ ê²€ìƒ‰ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                    if (!confirm(`ì´ ${rows.length}ê°œ í’ˆëª©ì˜ ì‹¤ì‚¬ì¬ê³ ë¥¼ DBì— ì €ì¥(ì—…ë°ì´íŠ¸)í•©ë‹ˆë‹¤.\n\n[ì£¼ì˜]\nì´ ëª©ë¡ì— ì—†ëŠ” ìƒí’ˆì˜ ì‹¤ì‚¬ì¬ê³ ëŠ” ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { return; }
                    const itemsToSubmit = [];
                    rows.forEach(row => { itemsToSubmit.push({ barcode: row.dataset.barcode, quantity: parseInt(row.querySelector('.scan-quantity-input').value, 10) || 0 }); });
                    submitBtn.disabled = true;
                    toggleScanBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì €ì¥ ì¤‘...';
                    fetch("{{ url_for('bulk_update_actual_stock') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: itemsToSubmit })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            tableBody.innerHTML = '';
                            updateTotalStatus();
                            window.location.reload();
                        } else { alert(`ì €ì¥ ì˜¤ë¥˜: ${data.message}`); }
                    })
                    .catch(error => { console.error('ì €ì¥ API ì˜¤ë¥˜:', error); alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); })
                    .finally(() => {
                        submitBtn.disabled = false;
                        toggleScanBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-send-check me-1"></i>ìµœì¢… ì €ì¥';
                    });
                });
            }
            
            if(clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (tableBody.querySelectorAll('tr').length > 0 && confirm('ìŠ¤ìº” ëª©ë¡ì„ ëª¨ë‘ ì§€ì›ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        tableBody.innerHTML = '';
                        updateTotalStatus();
                        statusAlert.style.display = 'none';
                    }
                });
            }


            // --- (*** ì‹ ê·œ: ì—‘ì…€ ë¶„ì„ ë° ë“œë¡­ë‹¤ìš´ UI ë¡œì§ ***) ---

            /**
             * íŠ¹ì • í¼(ë§¤ì¥/ë³¸ì‚¬)ì— ëŒ€í•œ ì—‘ì…€ ë¶„ì„ê¸°ëŠ¥ì„ ì„¤ì •í•©ë‹ˆë‹¤.
             * @param {string} fileInputId - <input type="file">ì˜ ID
             * @param {string} formId - <form> íƒœê·¸ì˜ ID
             * @param {string} wrapperId - íŒŒì¼ ì—…ë¡œë“œ <label> ë˜í¼ì˜ ID
             * @param {string} statusId - íŒŒì¼ ìƒíƒœ í…ìŠ¤íŠ¸ì˜ ID
             * @param {string} gridId - ì»¬ëŸ¼ ë§¤í•‘ ê·¸ë¦¬ë“œ(<select> ë˜í¼)ì˜ ID
             * @param {string} analyzeUrl - '/api/analyze_excel' ì—”ë“œí¬ì¸íŠ¸ URL
             */
            function setupExcelAnalyzer(fileInputId, formId, wrapperId, statusId, gridId, analyzeUrl) {
                const fileInput = document.getElementById(fileInputId);
                const form = document.getElementById(formId);
                const wrapper = document.getElementById(wrapperId);
                const statusText = document.getElementById(statusId);
                const grid = document.getElementById(gridId);
                const submitButton = form.querySelector('button[type="submit"]');
                const selects = grid.querySelectorAll('select');
                const previews = grid.querySelectorAll('.col-preview');

                let currentPreviewData = {};
                let currentColumnLetters = [];

                // 1. íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        resetUi();
                        return;
                    }

                    // UI: ë¡œë”© ìƒíƒœ
                    wrapper.classList.remove('success', 'error');
                    wrapper.classList.add('loading');
                    statusText.textContent = 'íŒŒì¼ ë¶„ì„ ì¤‘... (ë¡œë”©...)';
                    grid.style.display = 'none';
                    submitButton.style.display = 'none';
                    disableSelects();

                    // API í˜¸ì¶œ
                    const formData = new FormData();
                    formData.append('excel_file', file);

                    try {
                        const response = await fetch(analyzeUrl, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();

                        if (!response.ok || data.status === 'error') {
                            throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                        }
                        
                        // API ì„±ê³µ
                        currentPreviewData = data.preview_data;
                        currentColumnLetters = data.column_letters;
                        
                        populateSelects();

                        wrapper.classList.remove('loading');
                        wrapper.classList.add('success');
                        statusText.textContent = `ë¶„ì„ ì™„ë£Œ: ${file.name} (ì´ ${currentColumnLetters.length}ê°œ ì—´)`;
                        grid.style.display = 'grid'; // ê·¸ë¦¬ë“œ í‘œì‹œ
                        submitButton.style.display = 'block'; // ë²„íŠ¼ í‘œì‹œ

                    } catch (error) {
                        // API ì‹¤íŒ¨
                        console.error('Excel Analyze Error:', error);
                        resetUi();
                        wrapper.classList.remove('loading');
                        wrapper.classList.add('error');
                        statusText.textContent = `ë¶„ì„ ì‹¤íŒ¨: ${error.message}`;
                        alert(`[ì—‘ì…€ ë¶„ì„ ì˜¤ë¥˜]\n${error.message}\n\níŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                    }
                });

                // 2. ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                function populateSelects() {
                    selects.forEach(select => {
                        select.innerHTML = '<option value="">-- ì—´ ì„ íƒ --</option>'; // ì´ˆê¸°í™”
                        currentColumnLetters.forEach(letter => {
                            const option = document.createElement('option');
                            option.value = letter;
                            option.textContent = letter;
                            select.appendChild(option);
                        });
                        select.disabled = false; // í™œì„±í™”
                    });
                    
                    // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ì´ˆê¸°í™”
                    previews.forEach(preview => {
                        preview.innerHTML = '';
                    });
                }
                
                // 3. ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                grid.addEventListener('change', (e) => {
                    if (e.target.tagName !== 'SELECT') return;

                    const selectedLetter = e.target.value;
                    const previewId = `preview_${e.target.id}`; // ì˜ˆ: preview_col_pn_store
                    const previewEl = document.getElementById(previewId);

                    if (!previewEl) return;

                    if (selectedLetter && currentPreviewData[selectedLetter]) {
                        const previewHtml = currentPreviewData[selectedLetter]
                            .map(item => `<li>${item || '(ë¹ˆ ê°’)'}</li>`)
                            .join('');
                        previewEl.innerHTML = `<ul>${previewHtml}</ul>`;
                    } else {
                        previewEl.innerHTML = '';
                    }
                });

                // 4. UI ë¦¬ì…‹ (íŒŒì¼ì´ ì·¨ì†Œë˜ê±°ë‚˜ ì˜¤ë¥˜ ì‹œ)
                function resetUi() {
                    wrapper.classList.remove('success', 'error', 'loading');
                    statusText.textContent = 'ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.';
                    grid.style.display = 'none';
                    submitButton.style.display = 'none';
                    currentPreviewData = {};
                    currentColumnLetters = [];
                    disableSelects();
                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
                    fileInput.value = ''; 
                }
                
                function disableSelects() {
                     selects.forEach(select => {
                        select.innerHTML = '<option value="">-- ì—´ ì„ íƒ --</option>';
                        select.disabled = true;
                    });
                    previews.forEach(preview => {
                        preview.innerHTML = '';
                    });
                }
            }

            // --- ì—‘ì…€ ë¶„ì„ê¸° ì‹¤í–‰ ---
            
            // (1) ë§¤ì¥ì¬ê³  í¼ ì„¤ì •
            setupExcelAnalyzer(
                'store_stock_excel_file',      // íŒŒì¼ input ID
                'form-update-store',           // í¼ ID
                'wrapper-store-file',          // íŒŒì¼ <label> ë˜í¼ ID
                'status-store-file',           // íŒŒì¼ ìƒíƒœ í…ìŠ¤íŠ¸ ID
                'grid-update-store',           // <select> ê·¸ë¦¬ë“œ ID
                "{{ url_for('analyze_excel') }}" // (*** ì˜¤ë¥˜ ìˆ˜ì • ***)
            );

            // (2) ë³¸ì‚¬ì¬ê³  í¼ ì„¤ì •
            setupExcelAnalyzer(
                'hq_stock_excel_file',         // íŒŒì¼ input ID
                'form-update-hq',              // í¼ ID
                'wrapper-hq-file',             // íŒŒì¼ <label> ë˜í¼ ID
                'status-hq-file',              // íŒŒì¼ ìƒíƒœ í…ìŠ¤íŠ¸ ID
                'grid-update-hq',              // <select> ê·¸ë¦¬ë“œ ID
                "{{ url_for('analyze_excel') }}" // (*** ì˜¤ë¥˜ ìˆ˜ì • ***)
            );

        });
    </script>
</body>
</html>